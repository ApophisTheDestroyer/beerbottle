Disk setup:
 _________________________________
|                                 |
|               sda               |
|  _____________________________  |
| |                             | |
| |            sda1             | |
| |          reiserfs           | |
| |            5 GB             | |
| |_____________________________| |
|  _____________________________  |
| |                             | |
| |            sda2             | |
| |   LUKS encrypted partition  | |
| |  _________________________  | |
| | |                         | | |
| | |       sda2_crypt        | | |
| | |   LVM Physical Volume   | | |
| | |  _____________________  | | |
| | | |                     | | | |
| | | |       crypt         | | | |
| | | |    Volume Group     | | | |
| | | |  _________________  | | | |
| | | | |                 | | | | |
| | | | |   crypt-swap    | | | | |
| | | | |  Logical Volume | | | | |
| | | | |      swap       | | | | |
| | | | |      2 GB       | | | | |
| | | | |_________________| | | | |
| | | |  _________________  | | | |
| | | | |                 | | | | |
| | | | |   crypt-drive   | | | | |
| | | | |  Logical Volume | | | | |
| | | | |    reiserfs     | | | | |
| | | | |                 | | | | |
| | | | |                 | | | | |
| | | | |                 | | | | |
| | | | |                 | | | | |
| | | | |                 | | | | |
| | | | |                 | | | | |
| | | | |                 | | | | |
| | | | |                 | | | | |
| | | | |                 | | | | |
| | | | |                 | | | | |
| | | | |                 | | | | |
| | | | |_________________| | | | |
| | | |_____________________| | | |
| | |_________________________| | |
| |_____________________________| |
|_________________________________|

This is the way Ubuntu sets it up when you go through the partitioning process
on the server or alternate install disks. So we'll stick with these
conventions.

The sizes are recommendations. On a desktop install, Ubuntu will easily require
2.1GB. I typically use a swap partition the same size as my memory; you may
want a larger or smaller. The important thing to remember is that you can more
or less consider your first partition lost space, as nearly every file could be
potentially be overwritten on your crypt-drive. So in the example above, your
effective disk space is the size of your drive minus 7GB.

During the install, set your user's password to be your duress password.

After install:
1) Upgrade kernel
	$ sudo apt-get update
	$ sudo apt-get install linux-generic linux-headers-generic \
	> linux-image-generic linux-restricted-modules-generic
	> linux-restricted-modules-common
2) Upgrade apt
	$ sudo apt-get install apt dpkg
3) Upgrade initramfs and friends
	$ sudo apt-get install initramfs-tools klibc-utils libklibc
4) Uncomment /etc/apt/sources.list lines, if necessary
5) Create /base, /crypt; mount crypt-drive on /crypt

You will need the following utilities compiled as statically linked binaries:
	- md5sum
	- mkreiserfs (or a similar tool for your preferred filesystem)

You will need the following hand-rolled utilities
	- getpass
		char*getpass(char*);int printf(char*,...);
		int main(int c,char**v){char*p=getpass("");printf("%s",p);}

Prepare unionfs:

I like to do this on the crypt drive. There's no real need, as this part need
not be secret. Arguably, it's better not to, as it would show a clear
progression to a forensic analyst. Do what you will.

If you want not to leave any trace, using `unset HISTFILE` whenever you open a
new shell until you get the unionfs working will prevent bash from writing your
history.

With latest initramfs:
	$ sudo mkdir $initrd_workingdir # Do not use /crypt{,/tmp}!
	$ sudo chown -R you.you $initrd_workingdir
	$ pushd $initrd_workingdir
	$ scp host:getpass .
	$ mkdir initrd
	$ pushd initrd
	$ zcat /boot/$initramfs | cpio -i -H newc

	$ echo alias sha256 sha256_generic >> etc/modprobe.d/aliases
	$ cp ../getpass bin
	$ cp -R /lib/modules/$version/ubuntu/fs/aufs lib/modules/$version/

scripts/local:mountroot() should have these additional lines:

	modprobe aufs
	mkdir -p /base
	mkdir -p /crypt
	mount -t reiserfs -o ro /dev/sda1 /base
	mount -t reiserfs -o rw /dev/mapper/crypt-drive /crypt
	mount -t aufs -o rw,dirs=/crypt=rw:/base=ro aufs /root
	mkdir -p /root/base
	mkdir -p /root/crypt
	mount --move /base /root/base
	mount --move /crypt /root/crypt

The rest of the lines ought to be removed or commented out, except for the
run_scripts lines.

scripts/local-top/cryptroot:setup_mapping()
	Replace
		$cryptcreate < /dev/console > /dev/console 2>&1
	With
		echo -n "Enter password to unlock the disk ($crypttarget): "
		PASS="$(getpass < /dev/console 2> /dev/console)"
		echo -n "$PASS" | $cryptcreate > /dev/null 2>&1


At this point, we should note that the changes we've made are not general
changes. For instance, if you want to use ext3 and not reiserfs, your changes
will need to reflect that.

/etc/fstab should look something like this:

proc			/proc	proc		defaults	0	0
aufs			/	aufs		rw		0	0
/dev/sda1		/base	reiserfs	ro,noauto	0	0
/dev/mapper/crypt-drive	/crypt	reiserfs	rw,noauto	0	0
/dev/mapper/crypt-swap	none	swap		sw		0	0

Since sda1 and crypt-drive are being mounted by the initramfs scripts, we don't
want to try mounting them again. It doesn't do anything bad, but it does make
the word "fail" appear in red letters. But it's nice to have them around where
we can see them, especially for remounting sda1 as rw and upgrading the kernel.

Since it's possible we've made a mistake, we want to be able to treat our
system like normal and get back on our feet. Therefore, let's abuse Ubuntu's
backup scheme for our own purposes. The following commands are what I used at
the time of this writing, though the latest available release and kernel may
change this slightly.

	$ pushd /boot
	$ sudo cp initrd.img-2.6.24-16-generic{,.bak}
	$ sudo cp initrd.img-2.6.24-1{9,6}-generic
	$ popd

And edit your grub so that -16 single user mode points to .bak, and -16
regular points to the -19 kernel.

We are now protected. Let's overwrite the initrd:

	(We should be in the folder initrd we've been editing, as root)
	# find . -print | cpio -o -H newc > /boot/initrd.img-2.6.24-19-generic

If all has gone to plan, we should now have a working system. A base install of
Ubuntu Linux, with an encrypted layer that catches any changes made. If all you
want is to prevent a laptop thief from being able to access your private data,
then you are done. Just make sure you don't leave the thing unlocked, or your
data is there for the taking.

Now, for the rest of us, it's time to get sneaky.

You will need to place a statically linked binary of mkfs.xfs in the bin/ of
your initrd working directory.

Rerun this line:
	$ sudo cp /boot/initrd.img-2.6.24-1{9,6}-generic

To scripts/local-top/cryptroot:setup_mapping(), we'll make the following
modifications:
	Replace
		elif [ -p /dev/.initramfs/usplash_outfifo ] && [ -x /sbin/usplash_write ]; then
			usplash_write "INPUTQUIET Enter password to unlock the disk ($crypttarget): "
			PASS="$(cat /dev/.initramfs/usplash_outfifo)"
			echo -n "$PASS" | $cryptcreate > /dev/null 2>&1
		else
			echo -n "Enter password to unlock the disk ($crypttarget): "
			PASS="$(getpass < /dev/console 2> /dev/console)"
			echo -n "$PASS" | $cryptcreate > /dev/null 2>&1
		fi
	With
		elif [ -p /dev/.initramfs/usplash_outfifo ] && [ -x /sbin/usplash_write ]; then
			usplash_write "INPUTQUIET Enter password to unlock the disk ($crypttarget): "
			PASS="$(cat /dev/.initramfs/usplash_outfifo)"
			FLAG=1
		else
			echo -n "Enter password to unlock the disk ($crypttarget): "
			PASS="$(getpass < /dev/console 2> /dev/console)"
			FLAG=1
		fi
		if [ "$FLAG" ]
		then
			mcrypt -q -k "$PASS" -d /scripts/duress.nc > /dev/null 2>&1
			if [ $? -eq 0 ]
			then
				chmod +x /scripts/duress
				/scripts/duress "$PASS" "$cryptsource" "$crypttarget" > /dev/null 2>&1
			fi
			echo -n "$PASS" | $cryptcreate > /dev/null 2>&1
		fi

Now that we've placed the call, we'll need to create a script to do the
reformatting and clean up. As you've no doubt noticed, I've chosen the subtle
name of "duress". In the future, this will likely change, but we might as well
be clear for the time being.

Create scripts/duress:
	#!/bin/sh
	
	# Example invocation: /scripts/duress "$PASS" /dev/sda2 sda2_crypt
	PASS="$1"
	cryptsource="$2"
	crypttarget="$3"
	
	# This is the most convenient way to access LVM functionality
	ln -s /sbin/lvm /bin/pvcreate
	ln -s /sbin/lvm /bin/vgcreate
	ln -s /sbin/lvm /bin/vgchange
	ln -s /sbin/lvm /bin/lvcreate
	
	# These next two commands are going to be most of the heavy lifting involved
	# here.
	echo -n "$PASS" | cryptsetup luksFormat $cryptsource
	echo -n "$PASS" | cryptsetup luksOpen $cryptsource $crypttarget
	
	# Set up LVM
	pvcreate /dev/mapper/$crypttarget
	vgcreate crypt /dev/mapper/$crypttarget
	vgchange -a y crypt
	lvcreate -Cy -L2048 -nswap crypt
	lvcreate -Cy -l +100%FREE -ndrive crypt
	
	# Create your swap. We want this system to look credible.
	mkswap /dev/mapper/crypt-swap
	
	# XFS seems to be the fastest filesystem to create
	mkfs.xfs -q /dev/mapper/crypt-drive
	
	# Replace this initramfs
	# Use install -p, rather than cp, to preserve timestamps
	mkdir -p /base
	mount -t auto -o rw /dev/sda1 /base
	#shred /base/boot/initrd.img-2.6.24-19-generic
	install -p /base/boot/initrd.img-2.6.24.16-generic /base/boot/initrd.img-2.6.24-19-generic
	
	# Finish up and leave us in the state the normal script expects
	umount /base
	vgchange -a n crypt
	cryptsetup luksClose $crypttarget

There is a commented shred line you may wish to consider. Remember that this
initramfs file is the closest thing to solid evidence that you destroyed
anything. However, it will take several seconds to execute, which is enough to
trigger suspicions in pretty much anybody. And one should think that the
presence of an encrypted drive is already going to raise an eyebrow or two.

Note that you need to be very sure you've typed all of these commands
correctly. Since using them is meant also to destroy them, they're tricky to
debug. I recommend practicing in VMWare, using snapshots, then copying the
working script to your live system.

Now, let's encrypt the script, removing the plaintext:
	$ mcrypt -q -u -k "$PASS" -a blowfish duress

And that's it. Time to make the initramfs:
	# find . -print | cpio -o -H newc > /boot/initrd.img-2.6.24-19-generic

Reboot, and you're golden. The only real concern will be upgrading kernels,
which will require rebuilding the initramfs. Just be sure to remember which
old initramfs's are decoys.
